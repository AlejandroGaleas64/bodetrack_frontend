<!-- Overlay de carga -->
<div *ngIf="mostrarOverlayCarga" class="position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center bg-white bg-opacity-75" style="z-index: 1050;">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Cargando...</span>
  </div>
</div>

<!-- Breadcrumbs -->
<app-breadcrumbs title="Salidas" [breadcrumbItems]="breadCrumbItems"></app-breadcrumbs>

<div class="row">
  <div class="col-lg-12">
    <div class="card">
      <div class="card-body">
        <!-- Filtros -->
        <div class="row g-3 mb-3" *ngIf="!mostrarFormularioCrear && !mostrarFormularioDetalles">
          <div class="col-md-3">
            <label class="form-label fw-bold">Sucursal</label>
            <select class="form-select" [(ngModel)]="filtroSucursal">
              <option [ngValue]="null">Todas las sucursales</option>
              <option *ngFor="let suc of sucursales" [ngValue]="suc.sucs_Id">
                {{suc.sucs_Descripcion}}
              </option>
            </select>
          </div>

          <div class="col-md-3">
            <label class="form-label fw-bold">Fecha Inicio</label>
            <input type="date" class="form-control" [(ngModel)]="filtroFechaInicio">
          </div>

          <div class="col-md-3">
            <label class="form-label fw-bold">Fecha Fin</label>
            <input type="date" class="form-control" [(ngModel)]="filtroFechaFin">
          </div>

          <div class="col-md-3 d-flex align-items-end gap-2">
            <button type="button" class="btn btn-primary" (click)="aplicarFiltros()">
              <i class="ri-filter-line me-1"></i> Aplicar
            </button>
            <button type="button" class="btn btn-light" (click)="limpiarFiltros()">
              <i class="ri-refresh-line me-1"></i> Limpiar
            </button>
          </div>
        </div>

        <hr class="my-3" *ngIf="!mostrarFormularioCrear && !mostrarFormularioDetalles">

        <!-- Header: Búsqueda y Botón Nuevo -->
        <div class="d-flex justify-content-between mb-3" *ngIf="!mostrarFormularioCrear && !mostrarFormularioDetalles">
          <button type="button" class="btn btn-primary" (click)="crear()" *ngIf="userData?.empl_EsJefeBodega">
            <i class="ri-add-line align-bottom me-1"></i> Nueva Salida
          </button>
          
          <div class="search-box">
            <input type="text" class="form-control search" placeholder="Buscar..." 
                   [ngModel]="table.searchTerm" (ngModelChange)="table.setSearchTerm($event)">
            <i class="ri-search-line search-icon"></i>
          </div>
        </div>

        <!-- Formulario de Creación (Colapsable) -->
        <div class="row mb-3" *ngIf="mostrarFormularioCrear">
          <div class="col-lg-12">
             <app-create (onCancel)="cerrarFormulario()" (onSave)="guardarSalida($event)"></app-create>
          </div>
        </div>

        <!-- Formulario de Detalles (Colapsable) -->
        <div class="row mb-3" *ngIf="mostrarFormularioDetalles">
          <div class="col-lg-12">
             <app-details [salidaData]="salidaSeleccionada" (onCancel)="cerrarFormulario()" (onRecibir)="cargardatos()"></app-details>
          </div>
        </div>

        <!-- Tabla y Paginación -->
        <div [hidden]="mostrarFormularioCrear || mostrarFormularioDetalles">
          <div class="table-responsive">
            <table class="table align-middle table-nowrap table-hover table-striped mb-0">
              <thead class="table-light">
                <tr>
                  <th scope="col">Acciones</th>
                  <th scope="col" class="sort" (click)="table.sortBy('secuencia')" style="cursor: pointer;">
                    No. 
                  </th>
                  <th scope="col" class="sort" (click)="table.sortBy('sali_FechaSalida')" style="cursor: pointer;">
                    Fecha 
                  </th>
                  <th scope="col" class="sort" (click)="table.sortBy('sucursalDestino')" style="cursor: pointer;">
                    Sucursal 
                  </th>
                  <th scope="col" class="text-center">
                    Unidades 
                  </th>
                  <th scope="col" class="sort" (click)="table.sortBy('sali_EstadoSalida')" style="cursor: pointer;">
                    Estado 
                  </th>
                  <th scope="col" class="sort" (click)="table.sortBy('sali_CostoTotal')" style="cursor: pointer;">
                    Costo Total 
                  </th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let data of table.paginated$ | async">
                  <td class="position-relative">
                    <div class="dropdown-action-list">
                      
                      <button type="button"
                        class="dropdown-toggle btn btn-sm btn-light"
                        [attr.aria-expanded]="false"
                        (click)="floatingMenuService.open($event, data)">
                        Acciones
                      </button>
                    </div>
                  </td>
                  <td>{{data.secuencia}}</td>
                  <td>{{data.sali_FechaSalida | date:'dd/MM/yyyy HH:mm'}}</td>
                  <td>{{data.sucursalDestino || 'N/A'}}</td>
                  <td class="text-center">
                    <span class="badge bg-info-subtle text-info">{{data.unidadesTotales || 0}}</span>
                  </td>
                  <td>
                    <span class="badge" 
                      [ngClass]="{
                        'bg-warning-subtle text-warning': data.sali_EstadoSalida === 'Enviada a Sucursal',
                        'bg-success-subtle text-success': data.sali_EstadoSalida === 'Recibida en Sucursal'
                      }">
                      {{data.sali_EstadoSalida}}
                    </span>
                  </td>
                  <td>L {{data.sali_CostoTotal | number:'1.2-2'}}</td>
                </tr>
                <tr *ngIf="(table.total$ | async) === 0">
                  <td colspan="7" class="text-center">No hay registros encontrados</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Paginación -->
          <div class="row justify-content-between align-items-center mt-3">
            <div class="col-auto">
              <div class="dataTables_info">
                Mostrando {{ (table.page - 1) * table.pageSizeValue + 1 }} a 
                {{ ((table.page - 1) * table.pageSizeValue) + ((table.paginated$ | async)?.length || 0) }} 
                de {{ table.total$ | async }} registros
              </div>
            </div>
            <div class="col-auto">
              <pagination [totalItems]="(table.total$ | async) || 0" 
                          [ngModel]="table.page" 
                          [itemsPerPage]="table.pageSizeValue" 
                          (pageChanged)="table.setPage($event.page)">
              </pagination>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Menú Flotante -->
<ul
  *ngIf="floatingMenuService.show"
  class="dropdown-menu show"  
  [ngStyle]="{
    position: 'absolute',
    top: floatingMenuService.top + 'px',
    left: floatingMenuService.left + 'px'
  }"
  style="z-index: 10000;">
  <li>
    <button type="button" class="dropdown-item" (click)="detalles(floatingMenuService.data); floatingMenuService.close()">
      <i class="ri-eye-line me-2 align-bottom text-muted"></i> Ver Detalles
    </button>
  </li>
  <li *ngIf="floatingMenuService.data?.sali_EstadoSalida === 'Enviada a Sucursal'">
    <button type="button" class="dropdown-item text-success" (click)="recibirSalida(floatingMenuService.data); floatingMenuService.close()">
      <i class="ri-checkbox-circle-line me-2 align-bottom"></i> Recibir Salida
    </button>
  </li>
</ul>
